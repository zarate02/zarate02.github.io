---
title: "[CKA] 007. Cluster Upgrade"
date: 2026-01-19T00:00:02+09:00
slug: /2026_0008/
description: drain, uncordon, cordon, upgrade control plane, backup etcd
image: /images/devops/2026/cka.jpg #720*430
#caption: Photo by Gemini
categories:
  - devops
tags:
  - cka
draft: false
---
# basic command
- drain
    ```yaml
    kubectl drain [node-name]
    ```
- uncordon
    ```yaml
    kubectl uncordon [node-name]
    ```
- cordon
    ```yaml
    kubectl cordon [node-name]
    ```

# upgrade control plane
- version order
  1. kube-apiserver (x)
  2. kube-controller-manager, kube-scheduler (x-1)
  3. kubelet, kube-proxy (x-2)
  4. kubectl (x-1 ~ x+1)
- version upgrade step is 0.1

# backup etcd
- backup
    ```yaml
      spec:
        containers:
        - command:
          - etcd
          - --listen-client-urls=https://127.0.0.1:2379
          - --cert-file=/etc/kubernetes/pki/etcd/server.crt
          - --key-file=/etc/kubernetes/pki/etcd/server.key
          - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt
    ```
    ```yaml
      ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
      --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key \
      snapshot save /opt/snapshot-pre-boot.db
    ```
- restore
    ```yaml
    etcdutl snapshot restore /opt/snapshot-pre-boot.db --data-dir /var/lib/etcd-from-backup
    ```
- update info (/etc/kubernetes/manifests/etcd.yaml)
    ```yaml
      volumes:
      - hostPath:
          path: /var/lib/etcd-from-backup # Newly restored backup directory
          type: DirectoryOrCreate
        name: etcd-data
    ```
  